---
title: "dwc_mapping"
author: "Dimitri Brosens"
date: "17-3-2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Load libraries:

```{r message = FALSE}
library(tidyverse)      # To do data science
library(tidylog)        # To provide feedback on dplyr functions
library(magrittr)       # To use %<>% pipes
library(here)           # To find files
library(janitor)        # To clean input data
library(readxl)         # To read Excel files
library(digest)         # To generate hashes
library(rgbif)          # To use GBIF services
library(sp)             # coordinate transformation
library(leaflet)        # coordinate transformation
library(widgetframe)    # coordinate transformation
library(sf)             # coordinate transformation
library(lubridate)      # date transformation
```

# Read source data

Create a data frame `input_data` from the source data:
The source data was corrected in Excel
Muskrat occurrences opened in openRefine
Obsolete columns removed
some columns renamed to DwC term
File exported to csv

```{r}
#input_interim <- read_csv2(file = here:here("datasets", "mica-uvw-occurrences", "data", "raw", "2020_11_18_Vangstgegevens #muskus- en beverratten_NL_2019.csv"))  

input_data <- read.csv(file = here::here("datasets", "memo-occurrences", "data", "raw", "00_MEMO_DATABASE_GBIF.csv"), sep = ';')
```

Preview data:

```{r}
input_data %>% head(n = 5)
```

# Process source data

## Tidy data

Clean data somewhat:

```{r}
input_data %<>% remove_empty("rows")
```


delete obsolete columns

```{r}
input_data %<>% select(-c("phone_contact1","phone_contact2","phone_contact3","email_contact1","email_contact2","email_contact3","poe_street","poe_postalcode","contactname1","contactname2","contactname3","website","poe_contact_remark","collector_2","collector_3"))
```
fix issue with decimal lat and decimal long

```{r}
integer_part_lat <- map_chr(input_data$poe_latitude, function(x) str_split(x, pattern = "\\.")[[1]][1])

decimal_part_lat <- map(input_data$poe_latitude, function(x) {
 decimal_parts_lat <- NA_character_
 splitted_string_lat <- str_split(x, pattern = "\\.")[[1]]
 if (length(splitted_string_lat) > 1) {
   decimal_parts_lat <- paste0(splitted_string_lat[2:length(splitted_string_lat)])
   paste0(decimal_parts_lat, collapse = "")
   }
 else {
   ""
 }
})

integer_part_long <- map_chr(input_data$poe_longitude, function(x) str_split(x, pattern = "\\.")[[1]][1])

decimal_part_long <- map(input_data$poe_longitude, function(x) {
 decimal_parts_long <- NA_character_
 splitted_string_long <- str_split(x, pattern = "\\.")[[1]]
 if (length(splitted_string_long) > 1) {
   decimal_parts_long <- paste0(splitted_string_long[2:length(splitted_string_long)])
   paste0(decimal_parts_long, collapse = "")
   }
 else {
   ""
 }
})


input_data %<>%
 mutate(decimalLatitude_poe = as.numeric(paste(integer_part_lat, decimal_part_lat, sep = "."))) %>%
 mutate(decimalLongitude_poe = as.numeric(paste(integer_part_long, decimal_part_long, sep = ".")))
```



```{r}
input_data %>% head(n = 5)
```

# Georeference source data
data is already in WGS84

# Occurrence core

## Pre-processing

Create a dataframe occurrence data only 

```{r}
occurrence <- input_data
event <- input_data
```



# Term mapping

Map the data to [Darwin Core Event](https://rs.gbif.org/core/dwc_event_2016_06_21.xml).

Start with record-level terms which contain metadata about the dataset (which is generally the same for all records).
# Record-level
# Event 
## Remove obsolete columns for event

```{r}
event %<>% select(-c(latitude,longitude, trap_status,year, poe_latitude, poe_longitude, species.f, sex_collected, sex_stored, trap_code, pbs_code))
```
## eventID

```{r}
event %<>% mutate(dwc_eventID = Ã¯..sampling_code)
```


### type

```{r}
event %<>% mutate(dwc_type = "Event")
```

### language

```{r}
event %<>% mutate(dwc_language = "en") # e.g. "en"
```

### license

```{r}
event %<>% mutate(dwc_license = "http://creativecommons.org/publicdomain/zero/1.0/") 
# e.g. "http://creativecommons.org/publicdomain/zero/1.0/"
```

### rightsHolder

```{r}
event %<>% mutate(dwc_rightsHolder = "Institute of Tropical Medicine Antwerp") # e.g. "INBO"
```

### accessRights

```{r}
event %<>% mutate(dwc_accessRights = "http://www.inbo.be/en/norms-for-data-use") 
```
### institutionID


### datasetID

```{r}
event %<>% mutate(dwc_datasetID = "complete")
```

### institutionCode

```{r}
event %<>% mutate(dwc_institutionCode = "ITG") # e.g. "INBO"
```
### collectionCode

```{r}
event %<>% mutate(dwc_collectionID = "ITG:Memo")
```

### datasetName

```{r}
event %<>% mutate(dwc_datasetName = "MEMO - Exotic mosquitoes in Belgium") # e.g. "Checklist of non-native freshwater fishes in Flanders, Belgium"
```
### basisOfRecord

```{r}
event %<>% mutate(basisOfRecord = "HumanObservation")
```


```{r}
head(event, n = 10)
```


# Event

### eventDate

```{r}
 event %<>% mutate(eventDate = paste(dmy(start_date),dmy(end_date), sep = " / "))
```
### samplingProtocol

```{r}
event %<>% mutate(dwc_samplingProtocol = trap_type)
```


### habitat

```{r}
event %<>% mutate(dwc_habitat = pbs_type)
```


# Location

### locationID


### continent

```{r}
event %<>% mutate(continent = "Europe") # e.g. "Belgium = BE"
```

### countryCode

```{r}
event %<>% mutate(countryCode = "BE") # e.g. "Belgium = BE"
```

### municipality


```{r}
event %<>%
  mutate(municipality = poe_city)
```

### locality

```{r}
event %<>%
  mutate(municipality = poe_name_extra)
```

### decimalLatitude & decimalLongitude

```{r}
head(event, n = 5)
event %<>%
   mutate(dwc_decimalLongitude = round(decimalLongitude_poe, digits = 5)) %>%
   mutate(dwc_decimalLatitude = round(decimalLatitude_poe, digits = 5))
```


```{r}
event %<>%   
   mutate(dwc_decimalLatitude = as.character(format(dwc_decimalLatitude, nsmall = 5))) %>%
   mutate(dwc_decimalLongitude = as.character(format(dwc_decimalLongitude, nsmall = 5)))


   
```

### geodeticDatum

```{r}
event %<>%
  mutate(dwc_geodeticDatum = 'WGS84')
```

### coordinateUncertaintyInMeters


```{r}
event %<>%
  mutate(dwc_coordinateUncertaintyInMeters = '30')
```

### georeferenceRemarks

## Post-processing Event

```{r}
event %<>% select(starts_with("dwc_"))

colnames(event) <- str_remove(colnames(event), "dwc_")
  #remove collection columns
          ##  rename(scientificName = verbatimScientificName) 

event %<>% distinct()
```

The following terms contain information about the taxon:

### informationWithHeld

### dataGeneralizations

### dynamicProperties


### recordedBy

```{r}
occurrence %<>% mutate(recordedBy = WaterAuthorityName)
```









### identifiedBy

```{r}
occurrence %<>% mutate(identifiedBy = WaterAuthorityName)
```

Map the data to [Darwin Core Occurrence](http://rs.gbif.org/core/dwc_occurrence_2015-07-02.xml).

Start with record-level terms which contain metadata about the dataset (which is generally the same for all records).


### occurrenceID

**This need to be fixed**

```{r}
occurrence %<>% rename(occurrenceID = 'Id') 
#                mutate(occurrenceID = str_c("UVW:", occurrenceID))
```
### individualCount

```{r}
occurrence %<>% rename(individualCount='NumberOfCatches') 
```

### organismQuantity

### organismQuentityType

### sex

```{r}
occurrence %<>% mutate(sex = recode(Gender,
"Muskusrat" = "Muskusrat",
                   "jong"  = "juvenile",
                   "oud" = "adult",
                   "Onbekend" = "",
                                   ))
```

### lifeStage

```{r}
occurrence %<>% mutate(lifeStage = recode(Age,
"Muskusrat" = "Muskusrat",
                   "moer"  = "female",
                   "ram" = "male",
                   "Onbekend" = "",
                                   ))
```

### behavior

### occurrenceRemarks

```{r}
# occurrence %<>% rename(occurrenceRemarks = 'action_en')
```

### scientificName 

```{r}
head(occurrence, n=5)
occurrence %<>% mutate(scientificName = recode(CatchTypeName
                   , "Beverrat ram oud (>1jr)"  = "Myocastor coypus"
                   , "Muskusrat" = "Ondatra zibethicus"
                   , "Beverrat"  = "Myocastor coypus"
                   , "Muskusrat ram oud (>1jr)" = "Ondatra zibethicus"
                   , "Muskusrat ram jong (<1jr)" = "Ondatra zibethicus"
                   , "Muskusrat moer oud (>1jr)" = "Ondatra zibethicus"
                   , "Muskusrat moer jong (<1jr)" = "Ondatra zibethicus"
                                       ))
```

### kingdom

```{r}
occurrence %<>% mutate(kingdom = "Animalia")
```

### scientificNameAuthorship

```{r}
occurrence %<>% mutate(scientificNameAuthorship = recode(CatchTypeName
                  ,"Muskusrat" = "Linnaeus, 1766"
                  ,"Beverrat"  = "Molina, 1782"
                  ,"Beverrat ram oud (>1jr)"  = "Molina, 1782"
                  ,"Muskusrat ram oud (>1jr)" = "Linnaeus, 1766"
                  ,"Muskusrat ram jong (<1jr)" = "Linnaeus, 1766"
                  ,"Muskusrat moer oud (>1jr)" = "Linnaeus, 1766"
                  ,"Muskusrat moer jong (<1jr)" = "Linnaeus, 1766"
                                       ))
```

### verbatimScientificName

```{r}
occurrence %<>% mutate(verbatimScientificName = recode(CatchTypeName
                  , "Muskusrat" = "Muskusrat"
                  , "Beverrat"  = "Beverrat"
                  , "Beverrat ram oud (>1jr)"  =   "Beverrat"
                  , "Muskusrat ram oud (>1jr)" =   "Muskusrat"
                  , "Muskusrat ram jong (<1jr)" =  "Muskusrat"
                  , "Muskusrat moer oud (>1jr)" =  "Muskusrat"
                  , "Muskusrat moer jong (<1jr)" = "Muskusrat"
                                       ))
```

# taxonRank

```{r}
occurrence %<>% mutate(taxonRank = "species")
```

# nomenclaturalCode

```{r}
occurrence %<>% mutate(nomenclaturalCode = "ICZN") # e.g. "ICZN"
```

### occurrenceStatus

```{r}
occurrence %<>% 
    ##select(individualCount) %>%
    mutate(occurrenceStatus = case_when(individualCount > 0 ~ "present",
                              individualCount == 0 ~ "absent"
                                 )
                                )
```

## Post-processing

```{r}
colnames(occurrence) <- str_remove(colnames(occurrence), "dwc_")
occurrence %<>% select(-c(CatchTypeName, Gender, Age, HourSquareName, CreatedOn, year, month, day))  #remove collection columns
          ##  rename(scientificName = verbatimScientificName) 
```

Define the order of the output columns

```{r}
col_order <- c( "type","language","license","rightsHolder","accessRights","datasetID"
               ,"institutionCode","datasetName","basisOfRecord","occurrenceID","recordedBy"
               ,"individualCount","occurrenceStatus","eventDate","locationID", "continent","countryCode"
               ,"verbatimLatitude","verbatimLongitude","verbatimCoordinateSystem","verbatimSRS"
               ,"decimalLatitude","decimalLongitude","geodeticDatum","coordinateUncertaintyInMeters"
               ,"identifiedBy","scientificName","kingdom","scientificNameAuthorship","taxonRank","nomenclaturalCode"
               ) 
               # still needed for this dataset 
               # removed for this dataset,"occurrenceRemarks","municipality","samplingProtocol","samplingEffort"
occurrence <- occurrence[, col_order]
```

Preview data:

```{r}
occurrence %>% head()
```

Save to CSV:

```{r}
write_csv(occurrence, here::here("datasets/mica-uvw-occurrences", "data", "processed", "occurrence.csv"), na = "")



```
